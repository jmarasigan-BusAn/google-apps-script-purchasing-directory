function FINAL_AUTH_FIX() {
  // This line forces the editor to recognize that Drive access is required
  var testFile = DriveApp.createFile('AuthTest.txt', 'This is a test to force authorization.');
  console.log("File created: " + testFile.getUrl());
  testFile.setTrashed(true); // Deletes it immediately after testing
}

function doGet() {
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('Purchasing Directory')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function saveRecord(formData, fileData) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName("Data") || ss.insertSheet("Data");
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(["Company Name", "Registered Address", "TIN", "Vatable?", "Solutions JSON", "Type", "Contacts JSON", "Payment Terms", "File Link", "Timestamp"]);
    }
    const companyName = (formData.companyName || "").trim();
    if (!companyName) return "Error: Company Name is required.";
    let fileUrl = formData.existingFileUrl || "";
    if (fileData && fileData.base64) {
      // Updated with your specific Folder ID
      const folderId = "1rb8VQUo5WupLaCqVvKkpU_vXaUYbyEch"; 
      let folder;
      try { folder = DriveApp.getFolderById(folderId); } catch(e) { folder = DriveApp.getRootFolder(); }
      const blob = Utilities.newBlob(Utilities.base64Decode(fileData.base64), fileData.type, fileData.name);
      const file = folder.createFile(blob);
      fileUrl = file.getUrl();
    }
    const solutions = [];
    Object.keys(formData).forEach(key => {
      if (key.startsWith('brand')) {
        const idx = key.replace('brand', '');
        if (formData['brand' + idx]) {
          solutions.push({ brand: formData['brand' + idx], prod: formData['prod' + idx], det: formData['det' + idx], price: formData['price' + idx] });
        }
      }
    });
    const contacts = [];
    Object.keys(formData).forEach(key => {
      if (key.startsWith('cName')) {
        const idx = key.replace('cName', '');
        if (formData['cName' + idx]) {
          contacts.push({ name: formData['cName' + idx], des: formData['cDes' + idx], num: formData['cNum' + idx], email: formData['cEmail' + idx] });
        }
      }
    });
    const rowData = [companyName, formData.address || "", formData.tin || "", formData.vatable || "", JSON.stringify(solutions), formData.scale || "", JSON.stringify(contacts), formData.paymentTerms || "", fileUrl, new Date()];
    const data = sheet.getDataRange().getValues();
    let rowIndex = -1;
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toString().toLowerCase() === companyName.toLowerCase()) {
        rowIndex = i + 1;
        break;
      }
    }
    if (rowIndex > -1) {
      sheet.getRange(rowIndex, 1, 1, rowData.length).setValues([rowData]);
      return "Updated";
    } else {
      sheet.appendRow(rowData);
      return "Success";
    }
  } catch (e) { return "Error: " + e.toString(); }
}

function searchRecords(searchTerm) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("Data");
    if (!sheet) return [];
    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return [];
    
    // Using getDisplayValues ensures we search exactly what is visible
    const data = sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn()).getDisplayValues();
    const term = searchTerm.toString().toLowerCase().trim();
    if (!term) return [];

    return data.filter(row => {
      // Only search rows that actually have a Company Name
      if (!row[0]) return false; 
      return row.some(cell => cell.toString().toLowerCase().indexOf(term) !== -1);
    });
  } catch (e) { return []; }
}

function deleteRecord(companyName) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Data");
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toString().toLowerCase() === companyName.toLowerCase()) {
        sheet.deleteRow(i + 1);
        return "Deleted";
      }
    }
    return "Not Found";
  } catch (e) { return "Error: " + e.toString(); }
}

function forceAuth() {
  DriveApp.getRootFolder();
  SpreadsheetApp.getActiveSpreadsheet();
}