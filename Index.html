<!DOCTYPE html>
<html>
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --main-blue: #003366; --accent-blue: #0056b3; --bg-blue: #f8f9fa; }
    body { background-color: var(--bg-blue); font-family: 'Segoe UI', sans-serif; padding: 20px; }
    .container { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 1000px; margin: auto; }
    .header-btn { background: linear-gradient(135deg, var(--main-blue), var(--accent-blue)); color: white; text-align: center; padding: 18px; border-radius: 12px; font-weight: bold; text-transform: uppercase; margin-bottom: 35px; font-size: 1.6rem; }
    .table-section { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; margin-bottom: 20px; }
    .table-title { font-weight: bold; color: var(--main-blue); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .btn-save { background-color: var(--main-blue); border: none; padding: 15px; border-radius: 10px; font-weight: bold; color: white; width: 100%; transition: 0.3s; }
    .file-upload-section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px dashed #adb5bd; }
    .search-section { background: #e9ecef; padding: 30px; border-radius: 12px; margin-top: 45px; }
    .result-card { background: white; border-left: 8px solid var(--main-blue); padding: 20px; margin-top: 15px; border-radius: 8px; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    #successLabel { display: none; margin-bottom: 25px; }
    .action-btns { position: absolute; top: 15px; right: 15px; }
    
    /* Filter Styling */
    .filter-group .btn-check:checked + .btn { background-color: var(--main-blue); color: white; border-color: var(--main-blue); }

    /* Print Specific Styling */
    @media print {
      .d-print-none { display: none !important; }
      .result-card { border: 1px solid #ccc; box-shadow: none; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header-btn">Purchasing Directory</div>
  <div id="successLabel" class="alert alert-success text-center fw-bold"></div>

  <form id="pForm">
    <div class="row g-3">
      <div class="col-md-8"><label class="form-label fw-bold">Company Name</label><input type="text" name="companyName" id="companyName" class="form-control" required></div>
      <div class="col-md-4"><label class="form-label fw-bold">TIN</label><input type="text" name="tin" id="tin" class="form-control" placeholder="000-000-000-000" maxlength="15"></div>
      <div class="col-12"><label class="form-label fw-bold">Registered Address</label><input type="text" name="address" id="address" class="form-control"></div>
      <div class="col-md-4"><label class="form-label fw-bold">Vatable?</label><select name="vatable" id="vatable" class="form-select"><option>Yes</option><option>No</option></select></div>
      <div class="col-md-4"><label class="form-label fw-bold">Type</label><select name="scale" id="scale" class="form-select"><option>Local</option><option>International</option></select></div>
      <div class="col-md-4"><label class="form-label fw-bold">Payment Terms</label><input type="text" name="paymentTerms" id="paymentTerms" class="form-control"></div>

      <div class="col-12 mt-4">
        <div class="table-section">
          <div class="table-title">SOLUTIONS / PRODUCTS <button type="button" class="btn btn-sm btn-success" onclick="addRow('solutionsTable')">+</button></div>
          <div class="table-responsive">
            <table class="table table-sm" id="solutionsTable">
              <thead><tr><th>Brand</th><th>Product</th><th>Details</th><th>Price</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="table-section">
          <div class="table-title">CONTACT PERSONS <button type="button" class="btn btn-sm btn-success" onclick="addRow('contactsTable')">+</button></div>
          <div class="table-responsive">
            <table class="table table-sm" id="contactsTable">
              <thead><tr><th>Name</th><th>Designation</th><th>Contact #</th><th>Email</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="file-upload-section">
          <label class="form-label fw-bold">Attachment</label>
          <input type="file" id="fileInput" class="form-control">
          <input type="hidden" name="existingFileUrl" id="existingFileUrl">
        </div>
      </div>

      <div class="col-12"><button type="button" id="saveBtn" onclick="submitForm()" class="btn btn-save shadow">SAVE RECORD</button></div>
    </div>
  </form>

  <div class="search-section">
    <h4 class="mb-4 text-primary fw-bold">Search Records</h4>
    
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="input-group" style="max-width: 60%;">
        <input type="text" id="sInp" class="form-control" placeholder="Search by Company, Solution, or TIN...">
        <button class="btn btn-primary px-4" onclick="runSearch()">SEARCH</button>
      </div>
      <div class="btn-group filter-group" role="group">
        <input type="radio" class="btn-check" name="filterType" id="all" checked onclick="runSearch()">
        <label class="btn btn-outline-secondary btn-sm" for="all">All</label>
        
        <input type="radio" class="btn-check" name="filterType" id="local" onclick="runSearch()">
        <label class="btn btn-outline-secondary btn-sm" for="local">Local</label>
        
        <input type="radio" class="btn-check" name="filterType" id="intl" onclick="runSearch()">
        <label class="btn btn-outline-secondary btn-sm" for="intl">International</label>
      </div>
    </div>
    
    <div class="mb-3">
      <button class="btn btn-link btn-sm p-0 text-decoration-none text-muted" onclick="clearSearch()">Clear Results</button>
    </div>
    
    <div id="searchResults"></div>
  </div>
</div>

<script>
  let rowIdx = 0;
  window.onload = () => { addRow('solutionsTable'); addRow('contactsTable'); };

  // TIN Formatter: ###-###-###-###
  document.getElementById('tin').addEventListener('input', function (e) {
    let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,3})(\d{0,3})/);
    e.target.value = !x[2] ? x[1] : x[1] + '-' + x[2] + (x[3] ? '-' + x[3] : '') + (x[4] ? '-' + x[4] : '');
  });

  // Price Formatter with Peso Sign
  function formatCurrency(input) {
    let val = parseFloat(input.value.replace(/[^\d.-]/g, ''));
    if (!isNaN(val)) {
      input.value = "₱ " + val.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
  }

  function addRow(tableId, data = null) {
    const tbody = document.getElementById(tableId).querySelector('tbody');
    const row = tbody.insertRow();
    const id = rowIdx++;
    if (tableId === 'solutionsTable') {
      row.innerHTML = `<td><input type="text" name="brand${id}" class="form-control form-control-sm" value="${data?data.brand:''}"></td>
                       <td><input type="text" name="prod${id}" class="form-control form-control-sm" value="${data?data.prod:''}"></td>
                       <td><input type="text" name="det${id}" class="form-control form-control-sm" value="${data?data.det:''}"></td>
                       <td><input type="text" name="price${id}" class="form-control form-control-sm" onblur="formatCurrency(this)" placeholder="₱ 0.00" value="${data?data.price:''}"></td>
                       <td><button type="button" class="btn btn-sm text-danger" onclick="this.closest('tr').remove()">×</button></td>`;
    } else {
      row.innerHTML = `<td><input type="text" name="cName${id}" class="form-control form-control-sm" value="${data?data.name:''}"></td>
                       <td><input type="text" name="cDes${id}" class="form-control form-control-sm" value="${data?data.des:''}"></td>
                       <td><input type="text" name="cNum${id}" class="form-control form-control-sm" maxlength="11" placeholder="09########" value="${data?data.num:''}"></td>
                       <td><input type="email" name="cEmail${id}" class="form-control form-control-sm" value="${data?data.email:''}"></td>
                       <td><button type="button" class="btn btn-sm text-danger" onclick="this.closest('tr').remove()">×</button></td>`;
    }
  }

  function submitForm() {
    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.innerText = "Processing...";
    const form = document.getElementById('pForm');
    const formData = Object.fromEntries(new FormData(form));
    const file = document.getElementById('fileInput').files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileData = { base64: e.target.result.split(',')[1], type: file.type, name: file.name };
        executeSave(formData, fileData);
      };
      reader.readAsDataURL(file);
    } else { executeSave(formData, null); }
  }

  function executeSave(formData, fileData) {
    google.script.run.withSuccessHandler(res => {
      const label = document.getElementById('successLabel');
      label.innerText = res;
      label.style.display = 'block';
      document.getElementById('saveBtn').disabled = false;
      document.getElementById('saveBtn').innerText = "SAVE RECORD";
      if(!res.includes("Error")) {
        document.getElementById('pForm').reset();
        document.getElementById('existingFileUrl').value = "";
        document.querySelectorAll('tbody').forEach(t => t.innerHTML = "");
        addRow('solutionsTable'); addRow('contactsTable');
        setTimeout(() => label.style.display = 'none', 3000);
      }
    }).saveRecord(formData, fileData);
  }

  function runSearch() {
    const term = document.getElementById('sInp').value;
    if(!term) return;
    
    // Get filter selection
    const isLocal = document.getElementById('local').checked;
    const isIntl = document.getElementById('intl').checked;

    google.script.run.withSuccessHandler(results => {
      const div = document.getElementById('searchResults');
      div.innerHTML = "";
      
      // Filter results logic
      let filteredResults = results;
      if(isLocal) filteredResults = results.filter(row => row[5] === "Local");
      if(isIntl) filteredResults = results.filter(row => row[5] === "International");

      if(filteredResults.length === 0) { div.innerHTML = "No records found."; return; }
      
      filteredResults.forEach(row => {
        const sols = JSON.parse(row[4] || "[]");
        const conts = JSON.parse(row[6] || "[]");
        const printId = 'print-' + Math.random().toString(36).substr(2, 9);
        
        const card = document.createElement('div');
        card.className = 'result-card mb-4';
        card.setAttribute('id', printId);
        card.innerHTML = `
          <div class="action-btns d-print-none">
             <button class="btn btn-sm btn-outline-secondary me-1" onclick="printProfile('${printId}')">Print Profile</button>
             <button class="btn btn-sm btn-warning" onclick='editRecord(${JSON.stringify(row)})'>Edit</button>
             <button class="btn btn-sm btn-danger" onclick="confirmDelete('${row[0]}')">Delete</button>
          </div>
          <h4 class="fw-bold text-primary">${row[0]}</h4>
          <hr>
          <div class="row">
            <div class="col-md-6">
              <p class="mb-1"><strong>TIN:</strong> ${row[2]}</p>
              <p class="mb-1"><strong>Address:</strong> ${row[1]}</p>
              <p class="mb-1"><strong>Vatable:</strong> ${row[3]} | <strong>Type:</strong> ${row[5]}</p>
              <p class="mb-1"><strong>Terms:</strong> ${row[7]}</p>
            </div>
            <div class="col-md-6">
               <strong class="text-secondary small">SOLUTIONS & PRICING:</strong>
               <ul class="list-unstyled small mt-1">
                 ${sols.map(s => `<li>• ${s.brand} - ${s.prod}: <span class="fw-bold text-success">${s.price.includes('₱') ? s.price : '₱ ' + s.price}</span></li>`).join('')}
               </ul>
               <strong class="text-secondary small">CONTACTS:</strong>
               <ul class="list-unstyled small mt-1">
                 ${conts.map(c => `<li>• ${c.name} (${c.num}) - <span class="text-muted">${c.email}</span></li>`).join('')}
               </ul>
            </div>
          </div>
          ${row[8] ? `<a href="${row[8]}" target="_blank" class="btn btn-sm btn-info text-white mt-2 d-print-none">View Attachment</a>` : ''}
        `;
        div.appendChild(card);
      });
    }).searchRecords(term);
  }

  function printProfile(divId) {
    const content = document.getElementById(divId).cloneNode(true);
    const btns = content.querySelector('.action-btns');
    if (btns) btns.remove();
    const links = content.querySelectorAll('.d-print-none');
    links.forEach(l => l.remove());
    
    const printWindow = window.open('', '_blank', 'height=600,width=800');
    printWindow.document.write('<html><head><title>Supplier Profile</title>');
    printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">');
    printWindow.document.write('<style>body{padding:30px;} .text-primary{color:#003366 !important;} hr{border-top:2px solid #003366;}</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(content.innerHTML);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    
    setTimeout(() => {
      printWindow.focus();
      printWindow.print();
      printWindow.close();
    }, 500);
  }

  function editRecord(row) {
    document.getElementById('companyName').value = row[0];
    document.getElementById('address').value = row[1];
    document.getElementById('tin').value = row[2];
    document.getElementById('vatable').value = row[3];
    document.getElementById('scale').value = row[5];
    document.getElementById('paymentTerms').value = row[7];
    document.getElementById('existingFileUrl').value = row[8];
    const solBody = document.getElementById('solutionsTable').querySelector('tbody');
    solBody.innerHTML = "";
    JSON.parse(row[4] || "[]").forEach(s => addRow('solutionsTable', s));
    const conBody = document.getElementById('contactsTable').querySelector('tbody');
    conBody.innerHTML = "";
    JSON.parse(row[6] || "[]").forEach(c => addRow('contactsTable', c));
    window.scrollTo({top: 0, behavior: 'smooth'});
    document.getElementById('saveBtn').innerText = "UPDATE RECORD";
  }

  function confirmDelete(name) {
    if(confirm("Delete " + name + "?")) {
      google.script.run.withSuccessHandler(() => runSearch()).deleteRecord(name);
    }
  }

  function clearSearch() {
    document.getElementById('sInp').value = "";
    document.getElementById('searchResults').innerHTML = "";
    document.getElementById('all').checked = true;
  }
</script>
</body>
</html>
